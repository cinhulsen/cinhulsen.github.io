/***************************************
 * @preserve
 * Copyright (c) 2019 Verint Systems, Inc. All rights reserved.
 * ForeSee Web SDK: Trigger
 * Version: 19.11.2
 * Built: November 07, 2019, 12:47:06 CST
 ***************************************/
_fsDefine(["fs",_fsNormalizeUrl("$fs.utils.js"),_fsNormalizeUrl("$fs.compress.js"),"exports"],function(e,t,i,r){var s={SERVICE_TYPES:{mobileOnExitInitialize:{path:"/e",url:"/initialize"},mobileOnExitHeartbeat:{path:"/e",url:"/recordHeartbeat"}},ping:function(i,r,s,n){var o=new t.ImageTransport,a="https://"+e.globalConfig.mobileOnExitUrl+i.path+(i.url||"");o.send({url:a,success:s||function(){},failure:n||function(){},data:r})}},n=function(){function i(t,i,r,s){this.cfg=t,this.globalConfig=t.globalConfig||e.globalConfig,this.cpps=i,this.def=r,this.locale=i.get("locale")||"en",this.qual=s}var r=i.prototype;return r.decideModernSurvey=function(){var e=this.cfg.config.abSurveyType,t=e&&e.shouldTest&&this.globalConfig.modernSurveyUrl&&o(e,this.def);return this.cfg.config.onlyModernSurvey?{modernChosen:!0,modernPercentage:100}:t?{modernChosen:t.modernPercentage>=Math.floor(100*Math.random()),modernPercentage:t.modernPercentage}:{modernChosen:!1,modernPercentage:0}},r.getMeasureId=function(){return[this.def.name,this.def.site,this.def.section,this.locale,this.qual?this.qual.qualifiesValue:null].filter(function(e){return e}).join("-")},r.getUrl=function(){var e=this.decideModernSurvey();if(e.modernChosen)return this._buildUrl(this.globalConfig.modernSurveyUrl,this._getParams({}));var i=t.now()+"_"+Math.round(1e13*Math.random()),r=this._getParams({a:i,b:t.hash(i),c:864e5,mp:e.modernPercentage});return this._buildUrl(this.globalConfig.surveyUrl,r)},r._getParams=function(t){return e.ext({sid:this.getMeasureId(),cid:this.globalConfig.customerId,pattern:this.cpps.get(this.def.pattern)||this.def.pattern},t||{},!1)},r._buildUrl=function(t,i){var r=t+"?";for(var s in i)r+=e.enc(s)+"="+e.enc(i[s])+"&";return r+=this.cpps.toQueryString(["browser","os"])},r.getShortSurveyUrl=function(e){var t=e.pageView,i=e.paginationType,r=e.midOverride;try{if(1===t&&sessionStorage.removeItem("FSR_SSURL"),t>1){var s=sessionStorage.getItem("FSR_SSURL");if(s)return s}}catch(a){}var n=this.globalConfig.modernSurveyUrl,o=this._getParams({template:"contextual",pv:t,paginationType:i});return r&&(delete o.cid,delete o.sid,o.mid=r),o.paginationType||delete o.paginationType,this._buildUrl(n,o)},r.getShortSurveyOrigin=function(){return e.globalConfig.modernSurveyUrl.replace(/\/sv$/,"")},i}(),o=function(e,t){var i,r,s,n=t.name||"";for(n+="-"+(t.section||""),n+="-"+(t.site||""),i=0;i<e.defs.length;i++)if(r=(s=e.defs[i]).name||"",r+="-"+(s.section||""),(r+="-"+(s.site||""))===n)return s;return null},a=function(){function i(t,i,r,s,n,o){this.itype=t,this.cfg=i,this.def=r,this.cpps=s,this.rid=n,this._measureName=this.def.name+"-"+(e.isDefined(this.def.site)?this.def.site+"-":"")+(e.isDefined(this.def.section)?this.def.section+"-":"")+(o||this.def.language.locale)}var r=i.prototype;return r.init=function(i,r){r=r||function(){};var o=new n(this.cfg,this.cpps,this.def,null).decideModernSurvey(),a=t.now()+"_"+Math.round(1e13*Math.random()),c={a:a,notify:i,b:t.hash(a),c:864e5,cid:e.globalConfig.customerId,sid:this._measureName,rid:this.rid,uid:t.now(),support:"SMSEMAIL"==this.itype?"b":"EMAIL"==this.itype?"e":"s",cpps:"version="+encodeURIComponent(e.globalConfig.codeVer)+"&"+this.cpps.toQueryString()};o.modernChosen&&(c=e.ext({fs_renderer:"modern"},c)),s.ping(s.SERVICE_TYPES.mobileOnExitInitialize,c,r,r)},r.beginHeartbeat=function(){var i=this;this._timer&&(clearTimeout(this._timer),this._timer=null);var r=function(){s.ping(s.SERVICE_TYPES.mobileOnExitHeartbeat,{cid:e.globalConfig.customerId,sid:i._measureName,rid:i.rid,uid:t.now()},function(){},function(){})};this._timer=setInterval(r,this.cfg.config.onExitMobileHeartbeatInterval),r()},i}(),c={loadedEmitter:new t.FSEvent,initializedEmitter:new t.FSEvent,inviteShownEmitter:new t.FSEvent,inviteAcceptedEmitter:new t.FSEvent,inviteAbandonedEmitter:new t.FSEvent,inviteDeclinedEmitter:new t.FSEvent,trackerShownEmitter:new t.FSEvent,customInvitationRequested:new t.FSEvent,CPPS:null,_triggerResetLock:null,state:{didInvite:!1},inviteSetup:null},f="fs_inviteShown",l="fs_inviteAccepted",g="fs_inviteDeclined",u="fs_inviteAbandoned",d="fs_linksCancel",h=window,p=function(e,t,i,r,s,n,o,a){return c.inviteSetup?a.call(c.inviteSetup):c.inviteSetup=new v(e,t,i,r,s,n,o,a),c.inviteSetup},v=function(){function i(r,s,o,a,f,l,g,u){var d=this;this.trig=r,this.browser=s,this.stg=o,this.cpps=a,this.displayoverride=f,this.jrny=l,this.resourcesready=new t.FSEvent,this.triggerMethod=g;var p=e.getProductConfig("trigger");if(this.config=p,e.isDefined(this.trig.surveydef.inviteExclude)&&e.isDefined(this.trig.crit)&&this.trig.crit.runAllTests(this.trig.surveydef.inviteExclude,this.browser,!1,!0))return!1;h.fsReady(function(){var t;if(r.invite&&r.invite.dispose(),s.isMobile&&r.cfg.config.pagesInviteAvailable)if(null===(t=o.get("pia")))o.set("pia",r.cfg.config.pagesInviteAvailable-1);else if(t>0)o.set("pia",--t);else if(0===t)return;var l=i.getFittingDisplay(r.surveydef,f,a.get("locale"),s);o.set("dn",l.displayname),d.abTestShortSurvey(l),"SHORTSURVEY"!==l.inviteType?h._fsRequire([e.makeURI("$fs.invite.js")],function(e){d.invite=r.invite=new e(p,r.surveydef,s,l,a,c),u&&u.call(d)}):h._fsRequire([e.makeURI("$fs.shortsurvey.js")],function(e){var t=new n(p,a,r.surveydef);d.invite=r.invite=new e(p,r.surveydef,l,a,o,t),u&&u.call(d)})})}var r=i.prototype;return r.initialize=function(){var i=e.getProductConfig("trigger"),r=this.trig,s=this.stg,n=this.cpps,o=this.invite,a=this.jrny;this.didInitialize||(this.didInitialize=!0,a.addEventsDefault("properties",{fs_defName:[r.surveydef.name],fs_section:[r.surveydef.section],fs_displayName:[o.display.displayname],fs_displayTemplate:[o.display.template],fs_pvInvited:[r.pageViewCount],fs_language:[o.locale],fs_samplePercentage:[r.surveydef.criteria.sp.reg],fs_loyaltyFactor:[r.surveydef.criteria.lf],fs_environment:[e.isProduction?"production":"staging"],fs_deployType:[e.isSelfHosted?"on-prem":"cloud"],fs_inviteType:["intercept"],fs_triggerMethod:[this.triggerMethod]}),n.set("TriggerMethod",this.triggerMethod),n.set("dn",o.display.displayname),n.set("dt",o.display.template),o.loadResources(this.resourcesready),o.declined.subscribe(function(t){var o=e.isDefined(i.active_surveydef)&&e.isDefined(i.active_surveydef.repeatDays)?i.active_surveydef.repeatDays:i.config.repeatDays;s.set("i","d"),s.setMaxKeyExpiration(24*o.decline*60*60*1e3),a.addEventObj({name:g,properties:{action:[t]}}),c.inviteDeclinedEmitter.fire(r.surveydef,s,i,n),r.surveydef.cxRecord&&c.rec&&"y"!=s.get("fbr")&&(c.rec.cancelRecord(),r.recordController=c.rec=null),c.state.inviteSituation="DECLINED"}),o.abandoned.subscribe(function(){a.addEventString(u),s.set("i","a"),c.state.inviteSituation="ABANDONED",c.inviteAbandonedEmitter.fire(r.surveydef,s,i,n),s.set("rw",t.now()+i.config.reinviteDelayAfterInviteAbandon)}),o.accepted.subscribe(function(f,g){var u=e.isDefined(i.active_surveydef)&&e.isDefined(i.active_surveydef.repeatDays)?i.active_surveydef.repeatDays:i.config.repeatDays;switch(s.setMaxKeyExpiration(24*u.accept*60*60*1e3),c.inviteAcceptedEmitter.fire(r.surveydef,s,i,n),r.surveydef.cxRecord&&c.rec&&c.rec.recorder&&c.rec.beginTransmitting(),a.initPopupId(),a.addEventString(l),s.set("i","x"),c.state.inviteSituation="ACCEPTED",s.set("ixw",t.now()),f){case"TRACKER":r.popTracker(o);break;case"INSESSION":r.popSurvey();break;case"SMS":case"EMAIL":case"SMSEMAIL":m(r,g,f),r.stg.set("mhbi",{ui:g,it:f});break;case"SHORTSURVEY":break;default:throw new Error("Unknown inviteType: "+f)}}))},r.present=function(){var i=this,r=e.getProductConfig("trigger"),s=this.invite,n=this.stg,o=this.jrny,a=this.trig,l=this.cpps;c.state.didInvite||(c.state.didInvite=!0,this.resourcesready.subscribe(function(){var g=r.config.inviteDelay;null!=s.display.inviteDelay&&(g=s.display.inviteDelay);var u=Math.max(0,g-(t.now()-e.startTS));"SHORTSURVEY"===s.display.inviteType&&(u="p"===n.i?0:u),setTimeout(function(){i.invite.present(i.browser),"p"!==n.get("i")&&o.addEvent(f),n.set("ipt",t.now()),n.set("i","p"),c.state.inviteSituation="PRESENTED",c.inviteShownEmitter.fire(a.surveydef,n,r,l)},u)},!0,!0))},r.abTestShortSurvey=function(e){if("SHORTSURVEY"===e.inviteType&&e.shortSurvey&&e.shortSurvey.abTestPercent&&e.shortSurvey.abTestPercent<100&&e.shortSurvey.abTestPercent>0){var t=new n(this.config,this.cpps,this.trig.surveydef).getMeasureId()+"-"+e.displayname+"-AB",i=this.stg.get(t);if(null==i)i=100*Math.random()<=e.shortSurvey.abTestPercent?1:0,this.stg.set(t,i);i||(e.inviteType="TRACKER")}},i}(),m=function(i,r,s){var n=i.stg.get("ipt"),o=(t.now()-n)/1e3;i.cpps.set("invite_presented_interval",o);var c=new a(s,e.getProductConfig("trigger"),i.surveydef,i.cpps,i.stg.get("rid"),i.locale);i.stg.get("mhbi")?c.beginHeartbeat():c.init(r,function(){c.beginHeartbeat()})};v.getFittingDisplay=function(t,i,r,s){r=r||c.CPPS.get("locale")||"en";var n,o,a,f,l={},g={};if(n=(s=s||c.browser).isMobile&&t.display.mobile?t.display.mobile:t.display.desktop)for(f=0;f<n.length;f++)g=l.dialog||{},l=e.ext({},l),l=e.ext(l,n[f]),n[f].dialog&&l.dialog&&(l.dialog=e.ext(e.ext({},g),n[f].dialog)),n[f]=l;if(i){for(f=0;f<n.length;f++)if(n[f].displayname==i){a=n[f];break}}else a=n[Math.round(999999999999*Math.random())%n.length];return a.dialog.locales&&a.dialog.locales[r]&&(o=a.dialog.locales[r],a.dialog=e.ext(a.dialog,o),o.localeImages&&(a=e.ext(a,o.localeImages))),e.ext({inviteLogo:"",trackerLogo:"",siteLogoAlt:""},a)};var b=function(){function i(e,t,i){this.stg=e,this.cfg=t,this.cpps=i}var r=i.prototype;return r.calcReplayPoolStatus=function(i){var r,s=this.cfg.config,n=s.replay_pools,o=h.location.toString();if(!n||0===n.length||!0===this.pooloverride)return i(!0);var a=this.stg.get("pl");if(!e.isDefined(a))for(r=0;r<n.length;r++)t.testAgainstSearch(n[r].path,o)&&(a=100*Math.random()<n[r].sp?1:0,this.stg.set("pl",a,144e5));var c=s.replay_repools;if(0===a&&c&&c.length>0)for(r=0;r<c.length;r++)t.testAgainstSearch(c[r].path,o)&&(a=100*Math.random()<c[r].sp?1:0,this.stg.set("pl",a,144e5));return i(!!a)},r.optoutCheck=function(e,t){var i=this;this.stg.ready.subscribe(function(){!0===i.stg.get("optout")?t():e()},!0,!0)},r.browserCheck=function(e,t){return!(!e.isMobile&&t.config.browser_cutoff[e.browser.name]&&e.browser.actualVersion<t.config.browser_cutoff[e.browser.name])},r.featureCheck=function(e,i){return!(i.config.persistence==t.storageTypes.DS&&!e.supportsLocalStorage)},r.platformCheck=function(e,t){return!(t.config.platform_cutoff[e.os.name]&&e.os.version<t.config.platform_cutoff[e.os.name])},r.checkDeviceBlacklist=function(t,i){for(var r=0;r<i.config.device_blacklist.length;r++)if(e.toLowerCase(t.agent).indexOf(e.toLowerCase(i.config.device_blacklist[r]))>-1)return!1;return!0},r._match=function(e,t,i){var r=e.include,s=e[i||"globalExclude"];if(e.criteria){if(!e.criteria.supportsSmartPhones&&!t.isTablet&&t.isMobile)return!1;if(!e.criteria.supportsTablets&&t.isTablet)return!1;if(!e.criteria.supportsDesktop&&!t.isMobile)return!1}if(s&&this.runAllTests(s,t,!1,!0))return!1;return!r||this.runAllTests(r,t,!1,!0)},r.runAllTests=function(i,r,s,n){var o,a=new t.Cookie({}),c={urls:h.location.href.toString(),referrers:document.referrer.toString(),userAgents:h.navigator.userAgent};function f(e,i){Array.isArray(i)||(i=[i]);for(var r=0,s=i.length;r<s;r++)if("string"==typeof i[r]&&(i[r]=i[r].replace(/-_DS_-/gi,"$$")),t.testAgainstSearch(i[r],e))return!0;return!1}for(var l in i){var g=i[l];if(g.length>0){if(o=!1,c[l])o=f(c[l],g);else if("browsers"==l)for(var u=r.browser.name,d=r.browser.actualVersion,p=0;p<g.length;p++)e.toLowerCase(u).indexOf(e.toLowerCase(g[p].name))>-1&&(g[p].comparison?"lt"==g[p].comparison&&d<g[p].version?o=!0:"eq"==g[p].comparison&&d==g[p].version?o=!0:"gt"==g[p].comparison&&d>g[p].version&&(o=!0):o=!0);else if("cookies"==l)for(var v=0;v<g.length;v++){var m=g[v],b=a.get(m.name);e.isDefined(m.value)&&b==m.value?o=!0:!e.isDefined(m.value)&&b&&(o=!0)}else if("variables"==l)for(var y=0;y<g.length;y++){var w=g[y],S=t.retrieveNestedVariable(h,w.name);S||(S="boolean"!=typeof S&&"");var _=e.isDefined(w.value);_&&S===w.value?o=!0:_&&t.testAgainstSearch(w.value,S)?o=!0:!_&&S&&(o=!0)}else if("cpps"==l)for(var k=this.cpps.all(),I=0;I<g.length;I++){var E=g[I],C=E.name,T=E.value;if(C&&void 0!==typeof T){var D=k[C];void 0!==typeof D&&D===T&&(o=!0)}}if(!o&&s)return!0;if(o&&n)return!0}}return!1},i}(),y=function(){function i(e){this.cfg=e}var r=i.prototype;return r._bindToLink=function(i,r){for(var s=document.querySelectorAll(i.selector),n=function(e,i,r){return function(s){i.preventDefault&&t.preventDefault(s),r.call(e,i)}},o=0;o<s.length;o++){var a=s[o],c=!0,f=void 0;if(i.attribute&&(c=!1,(f=a.getAttribute(i.attribute))&&(c=!0,i.patterns&&i.patterns.length>0))){c=!1;for(var l=0;l<i.patterns.length;l++)if(e.toLowerCase(f).indexOf(e.toLowerCase(i.patterns[l]))>-1){c=!0;break}}c&&t.Bind(a,"trigger:click",n(this,i,r))}},r.performBindings=function(e){if(e&&this.cfg){var t,i=this.cfg;if(i.cancel&&i.cancel.length>0){var r=function(){e.cancelTracker(),e.jrny.addEventString(d)};for(t=0;t<i.cancel.length;t++)this._bindToLink(i.cancel[t],r)}if(i.survey&&i.survey.length>0){var s=function(){e.popSurvey()};for(t=0;t<i.survey.length;t++)this._bindToLink(i.survey[t],s)}if(!e.browser.isMobile&&i.tracker&&i.tracker.length>0){var n=function(){e.popTracker()};for(t=0;t<i.tracker.length;t++)this._bindToLink(i.tracker[t],n)}}},i}();function w(t,i,r,s,n,o){var a={width:700,height:350,left:50,top:50,resizable:"no",scrollbar:"1",scrollbars:"1",toolbar:"no",menubar:"no",location:"0",directories:"no",status:"no"},c=o?function(e,t){var i=void 0!==window.screenLeft?window.screenLeft:screen.left,r=void 0!==window.screenTop?window.screenTop:screen.top,s=window.innerWidth;window.innerWidth||(s=document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width);var n=window.innerHeight;window.innerHeight||(n=document.documentElement.clientHeight?document.documentElement.clientHeight:screen.Height);return{left:s/2-e/2+i,top:n/2-t/2+r}}(r.width||a.width,r.height||a.height):{},f=e.ext(a,r,c),l="";for(var g in f)l+=g+"="+f[g]+",";var u=this._win=h.open(t,i,l);if(u&&n)if(u.blur(),u.opener.window.focus(),h.focus(),"Firefox"==s.browser.name){var d=h.open("about:blank");d.focus(),d.close()}else s.isIE&&setTimeout(function(){u.blur(),u.opener.window.focus(),h.focus()},1e3);return u}var S=function(){function i(i,r,s,n,o,a,f){var l=this;c.tracker&&(c.tracker.dispose(),c.tracker=null),c.tracker=this,e.ext(this,{template:i,def:r,cfg:s,disp:a,_fcBindings:[]},!1),this.cpps=o,this.br=f,this.stg=n;var g=0;window.performance&&window.performance.timing&&(g=window.performance.timing.domComplete-window.performance.timing.navigationStart),this.hbi=3*Math.max(s.config.trackerHeartbeatTimeout,c.pageLoadTime,g),i&&c.trackerShownEmitter.fire(r,n,s,o),e.globalConfig.storage!==t.storageTypes.MC&&this.stg._readyState.subscribe(function(){if(n._serverFails>0){var e=t.getGeneralStorage(f);e.set("i","f"),c.state.inviteSituation="BRAINFAILED",e.set("fw",t.now()+432e5)}},!0,!1),this.stg.ready.subscribe(function(){l.stg.set("tracker_hb",t.now(),l.hbi,!1);var e=function(e){l.stg.set("page_hb",t.now(),l.hbi,!!e)},i=l.stg.onCommit.subscribe(function(){null===n.get("tracker_hb")?t.now()-l.lastTimeSeenTracker>l.cfg.config.trackerHeartbeatTimeout&&(i.unsubscribe(),delete l.lastTimeSeenTracker,l.dispose()):l.lastTimeSeenTracker=t.now()},!1,!1);l._heartbeat=setInterval(e,Math.round(.5*l.cfg.config.trackerHeartbeatTimeout)),e(!0)},!0,!0),t.Bind(h,"unload",function(){l.hbi=l.cfg.config.trackerHeartbeatLongTimeout,l.stg.set("page_hb",t.now(),l.hbi,!0)});var u=e.enc;this._url=e.makeURI(["$fs.tracker.html?uid=",u(n.uid||""),"&sitekey=",u(e.globalConfig.siteKey),"&domain=",u(t.getRootDomain()),"&gw=",u(e.makeURI("trigger/__gwtest__")),"&brain_url=",u(e.globalConfig.brainUrl),"&fsrlocale=",u(o.get("locale")||"en"),"&_svu_=",u(e.globalConfig.surveyUrl),"&_cv_=",u(e.globalConfig.codeVer),"&_issh_=",u(e.isSelfHosted),"&_vt_=",u(e.tagVersion),"&_au_=",u(e.globalConfig.analyticsUrl),"&_pa_=",u(e.assetLocation),e.codeLocation?"&_cl_="+u(e.codeLocation):""].join("")),this.cpps.onSet.subscribe(function(e,t){var i={};i[e]=t,l.stg.set("ckcpps",i,2e5,!1)}),this.stg.set("ckcpps",this.cpps.all(),2e5,!1),this._sendDefinition()}var r=i.prototype;return r._sendDefinition=function(){var i={method:"init",cfg:e.ext({active_surveydef:null},this.cfg,{globalConfig:e.globalConfig}),hb_i:this.hbi,cpps:this.cpps.all()};this.disp&&(i.display=this.disp),this.template&&(i.template=this.template),this.stg.set("page_hb",t.now(),this.cfg.config.trackerHeartbeatTimeout,!1),this.stg.set("trackerinfo",i,6e4,!1);var r=t.getGeneralStorage(this.br).get("ipt");this.stg.set("ipt",r),this.stg.set("ckcpps",this.cpps.all(),2e5,!1)},r.show=function(e){this.wref=w(this._url,"fsTracker",{width:700,height:450},e,!0,this.cfg.config.centerTrackerPopup)},r.applyExisting=function(e,t){this.wref=t,t.location=this._url},r.dispose=function(){for(var e=0;e<this._fcBindings.length;e++)this._fcBindings[e].unsubscribe();t.getGeneralStorage(this.br)===this.stg&&this.stg.dispose(),this.stg=null,clearInterval(this._heartbeat)},i}(),_=function(){function i(i,r,s,n,o,a){var c,f;this.stg=i,this.cfg=r,this.browser=s,this.crit=n,this.cpps=o,this.jrny=a;var l=e.globalConfig.adobeRsid;if(!i.get("pv")){for(f in c={browser:s.browser.name+" "+s.browser.version,os:s.os.name,referrer:document.referrer.toString(),site:t.getRootDomain(),sitekey:e.globalConfig.siteKey||""})e.hasProp(c,f)&&o.set(f,c[f]);t.INT.GA.has()&&t.INT.GA.uid(function(e){e&&o.set("GA_UID",e)});var g=function(e){o.set(e.name,e.value)};t.INT.OM.uid(l,g),t.INT.OM.mcid(l,g),t.INT.OM.beacon(function(e){o.set("OMTR_BEACON",e)})}this.heartbeatExpired=new t.FSEvent}var r=i.prototype;return r.doesPassCriteria=function(){var e=this.crit,t=this.cfg,i=c.state,r="DIDNOTPASSCRITERIA";if(e.platformCheck(this.browser,t))if(e.browserCheck(this.browser,t))if(e.checkDeviceBlacklist(this.browser,t)){if(e.featureCheck(this.browser,t))return!0;i.inviteStatus=r,i.reason="BROWSER"}else i.inviteStatus=r,i.reason="DEVICE";else i.inviteStatus=r,i.reason="BROWSER";else i.inviteStatus=r,i.reason="PLATFORM";return!1},r.popTracker=function(e){var i=this,r=this;if(this.stg.set("i","x"),c.state.inviteSituation="ACCEPTED",this.didPopTrackerAlready="y"==this.stg.get("tp"),c.state.didInvite=!0,!this.didPopTrackerAlready){this.stg.set("tp","y");if(e)r.tracker=new S(e.template,r.surveydef,i.cfg,t.getBrainStorage(r.browser,r.stg.uid),r.cpps,e.display,r.browser),r.tracker.show(r.browser);else{var s=w("about:blank","fsTracker",{width:700,height:400},this.browser,!0,this.cfg.config.centerTrackerPopup);p(this,r.browser,r.stg,r.cpps,!1,r.jrny,"Traditional",function(){r.tracker=new S(this.invite.template,r.surveydef,this.cfg,t.getBrainStorage(r.browser,r.stg.uid),r.cpps,this.invite.display,r.browser),r.tracker.applyExisting(r.browser,s),r.surveydef.cxRecord&&c.rec&&c.rec.recorder&&c.rec.beginTransmitting()})}}},r.canDisplayInvitation=function(){if(!this.crit._match(this.cfg.config,this.browser,"inviteExclude"))return!1;var e=v.getFittingDisplay(this.cfg.active_surveydef);if("SHORTSURVEY"===e.inviteType&&e.shortSurvey&&e.shortSurvey.idleViewsBeforeStop>0){var t=new n(this.cfg,this.cpps,this.surveydef).getMeasureId(),i=this.stg.get(t+"pc")||0;if(!this.stg.get(t+"li")&&e.shortSurvey.idleViewsBeforeStop<=i)return!1}return!0},r.popSurvey=function(e){(this.stg.set("i","x"),c.state.inviteSituation="ACCEPTED",this.didPopTrackerAlready="y"==this.stg.get("tp"),c.state.didInvite=!0,this.didPopTrackerAlready)?this.stg&&this.stg.get("page_hb")&&t.getBrainStorage(this.browser,this.stg.uid).set("trackercmd",{method:"survey"},6e4,!0):(this.stg.set("tp","y"),w(new n(this.cfg,this.cpps,this.surveydef,null,e).getUrl(),"acsSurvey",{width:700,height:400},this.browser,!1,this.cfg.config.centerTrackerPopup))},r.init=function(){for(var i,r,s,n,o=this.cfg.surveydefs,a=function(t,i){if(!e.isDefined(t))return null;var r=null;"number"==typeof t&&t>=0&&t<i.length?r=i[t].uid:"string"!=typeof t||(r=t);return r}(this.stg.get("def"),o),c=0;c<o.length;c++){if(!(s=o[c]).uid||"string"!=typeof s.uid)throw new Error('All survey definitions need a "uid" string property.');e.isDefined(a)&&s.uid==a&&(r=c,i=s),n&&(s=e.ext(n,s),!o[c].site&&n.site&&delete s.site,!o[c].section&&n.section&&delete s.section,o[c]=s),n=e.ext({},s)}if(i&&"default"!=i.selectMode&&"pin"!=i.selectMode){if(i)return this.cfg.active_surveydef=i,this.surveydef=i,this.locale=this._initLocale(),this.cpps.set("locale",this.locale),i.section&&this.cpps.set("section",i.section),i}else for(var f,l=i&&"pin"==i.selectMode?r+1:o.length,g=0;g<l;g++)if(f=o[g],r==g&&"pin"==i.selectMode||this.crit._match(f,this.browser))return"x"===this.stg.get("i")&&this.stg.set("def",f.uid,this.cfg.config.surveyDefResetTimeout||864e5),this.cfg.active_surveydef=f,this.surveydef=f,this.locale=this._initLocale(),this.cpps.set("locale",this.locale),f.section&&this.cpps.set("section",f.section),f;return i&&this.isTrackerAlive()?(this.tracker=new S(null,i,this.cfg,t.getBrainStorage(this.browser,this.stg.uid),this.cpps,null,this.browser),i):null},r._initLocale=function(){var i,r=this.surveydef,s=r.language;if(e.isDefined(s.src)&&e.isDefined(s.locales)){switch(s.src){case"variable":e.isDefined(s.name)&&(i=t.retrieveNestedVariable(window,s.name));break;case"cookie":if(e.isDefined(s.name))i=new t.Cookie({}).get(s.name);break;case"url":var n=s.locales;if(e.isDefined(n))for(var o=0,a=n.length;o<a;o++)if(e.isDefined(n[o].locale)&&e.isDefined(n[o].match)&&location.href.match(n[o].match))return this.locale=n[o].locale,n[o].criteria&&e.ext(this.surveydef.criteria,n[o].criteria),this.locale!==r.language.locale&&(r.language.locale=this.locale),n[o].locale;break;default:throw new Error("Unknown locale src: "+s.src)}if(i)for(var c=0;c<s.locales.length;c++)if(s.locales[c].match==i)return s.locale=s.locales[c].locale,s.locales[c].criteria&&e.ext(this.surveydef.criteria,s.locales[c].criteria),s.locale}return s.locale||"en"},r.isTrackerAlive=function(){return e.isDefined(this.stg.get("tracker_hb"))},r.cancelTracker=function(){t.getBrainStorage(this.browser,this.stg.uid).set("trackercmd",{method:"close"},6e4,!0),this.stg.set("i","a"),c.state.inviteSituation="ABANDONED",e.isDefined(this.tracker)&&clearInterval(this.tracker._heartbeat)},r.logState=function(){this.pageViewCount=(this.stg.get("pv")||0)+1,this.stg.set("pv",this.pageViewCount,this.cfg.config.pageViewsResetTimeout||864e5)},r.logDefState=function(){if(this.surveydef){var e=new n(this.cfg,this.cpps,this.surveydef).getMeasureId();this.defPageViewCount=(this.stg.get(e+"pv")||0)+1,this.stg.set(e+"pv",this.defPageViewCount,this.cfg.config.pageViewsResetTimeout||864e5)}},r.evalLoyaltySampling=function(t){var i=this.surveydef,r=i[t]||i.criteria,s=this.stg.get("pl"),n=e.isDefined(s)&&1!=s?r.sp.outreplaypool||0:r.sp.reg||0,o=100*Math.random();return this.defPageViewCount>=r.lf&&o<=n},r.dispose=function(){this.disposed||(this.stg.save(!0),this.disposed=!0,this.invite&&this.invite.dispose(),delete c.inviteSetup,this.mouseoff&&this.mouseoff.dispose(),c.rec&&(c.RecordController.disposeInstance(),c.RecordController=null,c.rec=null),t.Unbind("trigger:*"))},i}();var k,I,E=function(e,t,i,r,s,n){return new _(e,t,i,r,s,n)},C=new t.FSEvent;e.API.expose("CPPS",{set:function(e,t){C.subscribe(function(){c.CPPS.set(e,t)},!0,!0)},get:function(e,t){t=t||console.log,C.subscribe(function(){t(c.CPPS.get(e))},!0,!0)},all:function(e){e=e||console.table||console.log,C.subscribe(function(){e(c.CPPS.all())},!0,!0)}}),e.API.expose("clearState",function(){C.subscribe(function(){c.tracker&&c.tracker._heartbeat&&clearInterval(c.tracker._heartbeat),c.stg.reset(),e.supportsDomStorage&&sessionStorage.removeItem("acsFeedbackSubmitted"),c.rec&&c.rec.recorder&&c.rec.recorder.clearState()},!0,!0)}),e.API.expose("dispose",function(){C.subscribe(function(){c.trig&&c.trig.dispose()},!0,!0)}),e.API.expose("getState",function(e){e=e||console.log,C.subscribe(function(){e(c.state)},!0,!0)}),e.API.expose("getConfig",function(){return e.ext({},e.getProductConfig("trigger"),{global:e.globalConfig})}),e.API.expose("getConfigFormatted",function(){var t=e.getProductConfig("trigger");if(console&&console.info&&(console.info("************************** Trigger Configuration **************************"),console.info("Config: ",t.config),t.surveydefs&&t.surveydefs.length)){console.info("************************** Surveydefs Configuration **************************");for(var i=0;i<t.surveydefs.length;i++)console.info("************************** Surveydef "+(i+1)+" **************************"),console.info("Config: ",t.surveydefs[i])}}),e.API.expose("optOut",function(){var e=h.location.toString();h.location=e.indexOf("#")>-1?e+"&fscommand=fsoptout":e+"#fscommand=fsoptout",h.location.reload()}),e.API.expose("test",function(){var e=h.location.toString();h.location=e.indexOf("#")>-1?e+"&fscommand=fstest":e+"#fscommand=fstest",h.location.reload()});var T=function(){C.subscribe(function(){k&&(clearTimeout(k),k=null),k=setTimeout(function(){if(k=null,!c._triggerResetLock){c._triggerResetLock=!0;var t=c.trig;t&&(t.dispose(),c.trig=null),e.resetStartTS(),e.nextTick(I)}},250)},!0,!0)};e.API.expose("run",T),e.API.expose("pageReset",T),e.API.expose("showInvite",function(t){C.subscribe(function(){if(!document.getElementById("fsrInvite")&&!document.getElementById("acsMainInvite")){var i=c.trig||E(c.stg,e.getProductConfig("trigger"),c.browser,c.crit,c.CPPS);i.init()&&i.doesPassCriteria()&&i.surveydef&&(c.state.didInvite=!1,p(i,c.browser,c.stg,c.CPPS,t,c.jrny,"Traditional",function(){this.initialize(),this.present()}))}},!0,!0)}),e.API.expose("onLoaded",c.loadedEmitter),e.API.expose("onInitialized",c.initializedEmitter),e.API.expose("onInviteShown",c.inviteShownEmitter),e.API.expose("onInviteAccepted",c.inviteAcceptedEmitter),e.API.expose("onInviteAbandoned",c.inviteAbandonedEmitter),e.API.expose("onInviteDeclined",c.inviteDeclinedEmitter),e.API.expose("onTrackerShown",c.trackerShownEmitter),e.API.expose("customInvitationRequested",c.customInvitationRequested),e.API.expose("Journey",{addEvent:function(e){C.subscribe(function(){c.jrny.addEvent(e)},!0,!0)},addEventObj:function(e){C.subscribe(function(){c.jrny.addEventObj(e)},!0,!0)},addEventString:function(e){C.subscribe(function(){c.jrny.addEventString(e)},!0,!0)}}),e.API.expose("Storage",{get:function(e,t){t=t||console.log,C.subscribe(function(){t(c.stg.get(e))},!0,!0)},all:function(e){e=e||console.table||console.log,C.subscribe(function(){var t=c.stg.all(),i={};for(var r in t)1!==t[r].d&&(i[r]=t[r]);e(i)},!0,!0)}});var D=new t.Cookie({path:"/",secure:!1,encode:!0});e.API.expose("Cookie",{get:function(e,t){t=t||console.log||function(){},C.subscribe(function(){try{return t("_4c_"===e?JSON.parse(i.decompress(decodeURIComponent(D.get(e)))):D.get(e))}catch(r){console.error("trigger: couldn't read cookie",e)}},!0,!0)}});var P=function(t,i,r,s,n){e.ext(c,{CPPS:r,crit:i,stg:t,jrny:s,browser:n},!1),C.fire()};var R=function(i,r,s,n,o,a){r&&n&&e.globalConfig.products.record&&h._fsRequire([e.makeURI("$fs.record.js")],function(r){s.set("rc","true");var n={id:e.globalConfig.customerId||t.getRootDomain()||"record_customerId"};c.RecordController=r,c.rec=r.getInstance(i,h,s,n,o),a&&(a.recordController=c.rec)})},A={hash:h.location.hash,href:h.location.href,pathname:h.location.pathname},x=window!=h.top;function L(){var i=e.getProductConfig("trigger");if(c._triggerResetLock=!0,A.href.indexOf("fs.tracker.html")>-1)c._triggerResetLock=!1;else{var r=new t.Browser;r.ready.subscribe(function(){var s=t.getGeneralStorage(r),n=new t.CPPS(s,i.config.cppsResetTimeout);n.set("url",h.location.toString().replace(/(\?|&)(cpp\[[^&#]+\]+)=([^&#]*)/g,"")),n.set("env",e.isProduction?"prd":"stg");var o=new b(s,i,n);s.ready.subscribe(function(){s.upgradeOldStorage(function(){c.pageLoadTime=t.now()-e.startTS,t.initBehavioralData(e.globalConfig.customerId||t.getRootDomain()||"trigger_customerId",s,r,n);var a=c._journey=new t.Journey({customerId:e.globalConfig.customerId||t.getRootDomain()||"trigger_customerId",appId:t.APPID.TRIGGER,stg:s,browser:r,useSessionId:!0,usePopupId:!1});a.addEventsDefault("properties",{fs_site:[t.getRootDomain()],fs_repeatDaysAccept:[i.config.repeatDays.accept],fs_repeatDaysDecline:[i.config.repeatDays.decline],fs_reinviteDelayAfterInviteAbandon:[i.config.reinviteDelayAfterInviteAbandon]}),P(s,o,n,a,r);var f=s.get("i");setTimeout(function(){n.set("code",e.globalConfig.codeVer),n.set("tz",-(new Date).getTimezoneOffset()),n.set("product_type","web sdk");var l,g=t.getScreenResolution();if(n.set("device_width",g.w),n.set("device_height",g.h),n.set("dpr",window.devicePixelRatio||1),r.isMobile)n.set("window_width",g.w),n.set("window_height",g.h);else{var u=t.getSize(window);n.set("window_width",u.w),n.set("window_height",u.h)}if(i.config.cpps){var d,b,w=i.config.cpps;for(var _ in w){var k=w[_];if(e.isObject(k))switch(k.source){case"param":var I=e.getParam(k.val)||k.init||null;if(e.isDefined(k.mode)&&"append"==k.mode){var C=k.delimiter||",",T=n.get(_),D=T?T.split(C):[],P=void 0;I=I||"",D[D.length-1]!==I&&(D.push(I),P=D.join(C),n.set(_,P))}else e.isDefined(I)&&null!==I?n.set(_,I):n.get(_)||n.set(_,"");break;case"variable":if(e.isDefined(k.name)){d=k.exists;var A=t.retrieveNestedVariable(h,k.name);e.isDefined(d)?n.get(_)!==d.success&&n.set(_,A?d.success:d.init):A?n.set(_,A):n.get(_)||n.set(_,k.init||"")}break;case"cookie":var L=new t.Cookie({path:"/",secure:!1,encode:!0}).get(k.val),M=e.isDefined(L);d=k.exists,e.isDefined(d)?n.get(_)!==d.success&&n.set(_,M?d.success:d.init):e.isDefined(L)&&null!==L?n.set(_,L):n.get(_)||n.set(_,k.init||"");break;case"url":for(var O=0,U=k.patterns.length;O<U;O++){var N=k.patterns[O].regex||k.patterns[O].match;b=k.patterns[O].value,e.isString(location.href)&&t.testAgainstSearch(N,location.href)?n.set(_,b):n.get(_)||n.set(_,k.init||"")}break;default:throw new Error("Unknown CPP source: "+k.source)}else n.set(_,k)}}if(s.get("ovr")&&(l=JSON.parse(s.get("ovr"))),l){for(var V=0;V<i.surveydefs.length;V++){var B=i.surveydefs[V].name;l.sp[B]&&(i.surveydefs[V].criteria.sp=l.sp[B]),l.lf[B]&&(i.surveydefs[V].criteria.lf=l.lf[B])}!0===l.pooloverride&&(o.pooloverride=!0)}(c.state.codeVer=e.globalConfig.codeVer,c.state.siteKey=e.globalConfig.siteKey,c.state.didInvite="xda".indexOf(f)>-1,c.state.inviteSituation={x:"ACCEPTED",d:"DECLINED",a:"ABANDONED",p:"PRESENTED",f:"BRAINFAILED"}[f],"a"==f)&&(parseInt(s.get("rw"),10)<t.now()&&(s.erase("i"),s.erase("rw"),f=c.state.didInvite=null));"f"==f&&(parseInt(s.get("fw"),10)<t.now()&&(s.erase("f"),s.erase("fw"),f=c.state.didInvite=null));if("runRecordOnly"===i.config.workInIframes&&x){for(var j=!1,F=0;F<i.surveydefs.length;F++){if(i.surveydefs[F].cxRecord){j=!0;break}}return R(r,j,s,!0,n),void(c._triggerResetLock=!1)}if("d"!=f&&"a"!=f&&"f"!=f)o.calcReplayPoolStatus(function(l){l&&(c.state.isinpool=l),o.optoutCheck(function(){if(o._match(i.config,r,"globalExclude")&&"y"!=s.get("gx"))if(null===s.selectCookieDomain(e.globalConfig.cookieDomain,window.location.toString()))c._triggerResetLock=!1;else{var g=c.trig=E(s,i,r,o,n,a);if(g.logState(),n.set("pv",g.pageViewCount,i.config.pageViewsResetTimeout||864e5),g.init())if(c.initializedEmitter.fire(),g.isTrackerAlive()||g.doesPassCriteria())if(g.surveydef){if(g.logDefState(),R(r,g.surveydef.cxRecord,s,l,n),"x"!=f)r.isMobile||r.isTablet||!g.surveydef.mouseoff||"off"===g.surveydef.mouseoff.mode||1!=s.get("pv")||s.set("sst",t.now()),g.canDisplayInvitation()?g.evalLoyaltySampling("criteria")?(s.set("def",g.surveydef.uid,g.cfg.config.surveyDefResetTimeout||864e5),p(g,r,s,n,!1,a,"Traditional",function(){this.initialize(),this.present()})):s.get("sst")&&g.evalLoyaltySampling("mouseoff")?(s.set("def",g.surveydef.uid,g.cfg.config.surveyDefResetTimeout||864e5),h._fsRequire([e.makeURI("$fs.mouseoff.js")],function(e){c._triggerResetLock=!1;var t=g.mouseoff=new e(g,g.surveydef,r,s,a);t.initialize(),t.startListening(function(){this.inviteSetup=p(g,r,s,n,!1,a,"MouseOff",function(){this.initialize()})},function(){this.inviteSetup.present()})})):c._triggerResetLock=!1:c._triggerResetLock=!1;else{var u=g.stg.get("mhbi");if(u)m(g,u.ui,u.it);else if(g.isTrackerAlive()){var d=v.getFittingDisplay(g.surveydef);g.tracker=new S(d.template,g.surveydef,i,t.getBrainStorage(r,s.uid),n,d,r)}c._triggerResetLock=!1}g.surveydef.links&&new y(g.surveydef.links).performBindings(g)}else c._triggerResetLock=!1;else c._triggerResetLock=!1;else c._triggerResetLock=!1}else s.set("gx","y"),c._triggerResetLock=!1},function(){c._triggerResetLock=!1})});else{if("a"==f){var H="true"==s.get("rc")||!0===s.get("rc");R(r,H,s,H,n)}c._triggerResetLock=!1}},Math.max(0,i.config.triggerDelay-(t.now()-e.startTS)))})},!0,!0)},!0,!0)}}return r.startup=function(){var i,r=e.getProductConfig("trigger");if(!(r&&r.config&&r.surveydefs&&r.config.browser_cutoff))throw new Error("Looks like the trigger config is missing or broken. Please push a trigger config to fix this error.");if(r.surveydefs.length&&"string"==typeof r.surveydefs[0])throw new Error("Looks like an old trigger config from pre-19.9.0. Please re-push the trigger settings with 19.9.0+ to fix this error.");t.registerProduct("foresee",r),c.loadedEmitter.fire(),("dontRunOtherIframes"!==r.config.workInIframes&&r.config.workInIframes||!x)&&(h.__fsrtracker||h.location.toString().indexOf("survey.foreseeresults.com")>-1||(e.fsCmd("fstest")?h._fsRequire([e.makeURI("$fs.svadmin.js")],function(){}):e.fsCmd("fsoptout")?h._fsRequire([e.makeURI("$fs.optout.js")],function(){}):(e.domReady(L),I=L,r.config.ignoreNavigationEvents||t.pageNavEvent.subscribe(function(){var e=h,s=e.location,n=e[r.config.publicApiName||"FSR"],o=function(e){var t=e.split("#");return t.length>2?t[0]+t[1]:e.replace(/#/gi,"")},a=o(A.hash),c=o(s.hash);t.now()-t.startTime<(r.config.pageLoadUrlChangeBlackout||0)||(n&&a!=c||A.pathname!=s.pathname)&&h.fsReady(function(){clearTimeout(i),i=setTimeout(function(){A={hash:h.location.hash,href:h.location.href,pathname:h.location.pathname},n.pageReset()},1e3)})},!1,!1))))},r});
